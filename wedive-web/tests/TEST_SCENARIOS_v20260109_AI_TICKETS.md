# AIコンシェルジュ チケット報酬システム テストシナリオ (2026-01-09)

## 概要
AIコンシェルジュチケットの付与（ログイン・貢献）、消費、および同期が正しく動作することを検証するためのシナリオ。

## テスト項目

### 1. ログインボーナス付与 (JST判定の検証)
- **手順**: 
    1. テストユーザーでログイン。
    2. JST (日本標準時) で日付が変わった直後に再度アプリ/Webを開く。
- **期待される結果**:
    - 日本時間の深夜0時を過ぎた最初のアクセスで新しいチケットが1枚付与される。
    - `users/{uid}/aiConciergeTickets` に `type: 'daily'` のドキュメントが作成される。
    - `User` プロファイルの `lastDailyGrant` が今日の日付 (YYYY-MM-DD) に更新される。

### 2. テスト用チケット付与 (開発・デバッグ用)
- **手順**:
    - **Web**: 開発環境 (`import.meta.env.DEV`) でコンシェルジュページ右上の "[DEV] チケット付与" ボタンをクリック。
    - **App**: AIコンシェルジュ画面のロボットアイコンを長押し（Long Press）。
- **期待される結果**:
    - チケット残数が即座に +1 される。
    - プロフィールおよび SQLite のキャッシュが更新され、マイページにも反映される。

### 3. 同期と整合性 (App)
- **手順**:
    1. AIチャット画面でチケットを付与または消費する。
    2. 即座に「マイページ」タブに切り替える。
- **期待される結果**:
    - `refreshProfile` が走り、マイページのチケット枚数表示がAI画面での結果と一致している。
    - オフライン状態で消費した場合、SQLite の `totalAvailable` がマイナスされ、オンライン復帰時に Firestore と同期される。

### 4. キャンペーン貢献度表示 (Web/App共通)
- **手順**:
    1. マイページを開く。
    2. 「冬の冒険者キャンペーン貢献度」セクションを確認。
- **期待される結果**:
    - 各カテゴリ（スポット、生物、レビュー）の累計承認数が正しく表示されている。
    - Feature Flag (`ENABLE_V2_AI_CONCIERGE`) が OFF の場合はカード自体が表示されない。

### 5. チケット消費
- **手順**:
    1. AIコンシェルジュにメッセージを送り、回答を受け取る。
- **期待される結果**:
    - `totalAvailable` が 1 減る。
    - チケットドキュメントの `remainingCount` が減る。
    - 残数が 0 の場合、送信ボタンが制限され、チケット獲得を促すメッセージが表示される。
