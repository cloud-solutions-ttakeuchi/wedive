# 管理画面マニュアル (Admin Manual)

本ドキュメントでは、場所データ（Region / Zone / Area / Point）の管理を行う「管理画面 (Admin Area Cleansing Page)」の機能について説明します。

**アクセスURL**: `/admin/cleansing`

---

## 1. データ閲覧・検索機能

### 階層タブ切り替え
画面上部のタブで、表示・操作するデータの階層を切り替えることができます。
- **Region (都道府県/国)**: 最上位の区分（例: 沖縄本島、石垣島など）
- **Zone (エリア)**: Regionの下位区分（例: 恩納村、川平・石崎など）
- **Area (地区)**: Zoneの下位区分（例: 万座、マンタスクランブル周辺など）
- **Point (ダイビングポイント)**: 実際のダイビングスポット

### 複数条件フィルタリング (Multi-Select Filter)
リスト上部のドロップダウンを使用して、表示するデータを絞り込むことができます。
- **Region Filter**: 選択したRegion（複数可）に含まれるデータのみを表示します。
- **Zone Filter**: 選択したZone（複数可）に含まれるデータのみを表示します。
- **Area Filter** (Pointタブのみ): 選択したArea（複数可）等のポイントを表示します。
※ フィルタは連動しており、Regionを選択すると、その配下のZoneのみが選択肢として表示されます。

### 全データ表示
ポイントが登録されていない（0件の）Region/Zone/Areaもリストに表示されるため、未使用データの確認や整理が可能です。

---

## 2. マスタデータ管理機能 (CRUD)

### 新規作成 (Create)
Region, Zone, Area タブにある「+ Create New ...」ボタンから、新しい項目を追加できます。
- **Name**: 名称を入力
- **Description**: 説明文を入力
- **Parent**: 所属する親階層を選択（例: Areaを作成する場合は親Zoneを選択）

### 編集・移動 (Edit & Move)
各行の右側にある「Edit」ボタン（ペンアイコン）から、既存データの編集が可能です。
- **名称・説明の変更**: 誤字脱字の修正など。
- **親階層の変更 (移動)**: ドロップダウンで親を変更することで、データを別の場所に移動できます（例: Areaを別のZoneへ移動）。
    - **Pointの移動**: 間違ったAreaに登録してしまったPointも、こちらから正しいAreaに移動可能です。
        - **ゾーン選択で絞り込み**: エリアの選択肢が現在のゾーンに限定されて表示されます。別のゾーンへ移動したい場合は、下部の「Filter by Zone」を変更してください。
  - ※移動しても、その配下にあるPointデータは自動的に追従しますが、データ整合性のために「DB同期」が必要になる場合があります。

---

## 3. 一括操作機能 (Bulk Actions)

### 複数選択 (Checkboxes)
- 各行の左側にあるチェックボックスで、操作したいデータを選択します。
- ヘッダーのチェックボックスをクリックすると、表示されている全データを選択/解除できます。

### 一括削除 (Bulk Delete)
データを選択すると、画面下部にアクションバーが表示されます。「Bulk Delete」ボタンを押すと、選択したデータを一括で削除できます。
- **Pointの削除**: 関連するユーザーログ等は削除されませんが、ポイント情報は物理削除されます。
- **Region/Zone/Areaの削除**: その項目自体が削除されます。紐付いていたPointのフィールド（area名など）は空欄等の状態になります。

---

## 4. データ保守・連携機能

### 削除時のデータ整合性 (Deletion Behavior)
本管理画面での削除操作には、対象データによって挙動が異なります（安全設計）。

#### A. Region / Zone / Area の削除 (一括・個別共通)
これらを削除しても、配下の **Point (ダイビングポイント) 自体は削除されません**。
- **挙動**: 対象のマスタデータが削除され、紐付いていた Point 側の当該フィールド（region/zone/area名）は「未設定 (空文字)」の状態になります。また、`areaId` 等の内部リンクもクリアされます。
- **影響**: ポイントに紐付いている「生物情報」や「ユーザーのお気に入り」は**全て維持されます**。

#### B. Point の削除
Point を削除した場合は、データの不整合（ゴミデータ）が残らないように**カスケード削除**が行われます。
- **挙動**: Point ドキュメントが物理削除されます。
- **影響**:
    1. **生物紐付け (PointCreatures)**: そのポイントに関連する生物出現情報は全て削除されます。
    2. **お気に入り (Bookmarks)**: ユーザーがお気に入り登録していた場合、そのリストから削除されます。
    3. **Wantedリスト**: ユーザーが見たい生物リスト（場所指定）からも削除されます。
- **注意**: 削除されたポイントは復元できません。

### Export JSON (バックアップ)
画面上部のExportボタンから、以下のデータをJSON形式でダウンロードできます。
- **Export Locations**: 場所データ (`locations_seed.json` 形式)
- **Export Creatures**: 生物図鑑データ (`creatures_real.json` 形式)
- **Export Relations**: ポイント-生物紐付けデータ (`point_creatures_seed.json` 形式)

**用途**: データのバックアップ、または開発環境のシードファイルの更新に使用します。

### DB同期 (DB Sync)
「DB同期」ボタンをクリックすると、表示上のデータとFirestoreの最新状態を同期し、キャッシュ等の不整合を解消します。

### 重複修復 (Repair Duplicates)
「重複修復」ボタンは、システム上の重複IDや不整合データをスキャンして修復を試みます（開発者向け機能）。

### HARD RESET DB (※要注意)
**【危険】** データベースの場所データを全て削除し、初期シードデータで上書きリセットします。
- 開発中にデータが乱れすぎて初期状態に戻したい場合のみ使用してください。

### DELETE MY LOGS (※要注意)
ログイン中のユーザーの全ダイビングログを削除します。ログのインポートテスト等をやり直したい場合に使用します。
