# Staging Deployment Guide (Firebase Hosting)

このドキュメントでは、`dive-dex-app` のステージング環境（`dive-dex-app-dev`）へのデプロイ手順を説明します。

## 1. 前提条件
- **Node.js**: v20系推奨 (v18以降必須)
- **Firebase CLI**: インストール済みであること
  ```bash
  npm install -g firebase-tools
  # 権限エラーの場合は
  sudo npm install -g firebase-tools
  ```
- **Firebase Login**: 認証が完了していること
  ```bash
  firebase login
  ```

## ⚠️ 重要な注意点: データベースの共有について

**本プロジェクトでは、ローカル開発環境とステージング環境で「同じデータベース (`dive-dex-app-dev`)」を共有しています。**

*   **データの同期**: ローカル環境で変更したデータは、即座にステージング環境（および他の開発者のローカル環境）に反映されます。逆も同様です。
*   **リセットの影響**: ローカルで「DBリセット」を行うと、ステージング環境のデータもリセットされます。
*   **デプロイ時の注意**: デプロイ作業自体はデータベースを変更しませんが、デプロイ後の動作確認でデータを操作する際は、本番データ（もしあれば）や他の作業者に影響がないか注意してください。

## 2. デプロイ手順

### ステップ 1: ビルド
プロダクション用バンドルを作成します。
TypeScriptの型チェックとViteによるビルドが実行されます。

```bash
npm run build
```

> **注意**: ビルド成果物は `dist` ディレクトリに出力されます。PWA設定により、バンドルサイズ制限（`vite.config.ts` で 3MB に緩和済み）があります。

### ステップ 2: デプロイ
Firebase Hosting にデプロイします。

```bash
firebase deploy --only hosting
```

または、プロジェクトを明示指定する場合:
```bash
firebase deploy --only hosting --project dive-dex-app-dev
```

## 3. データベース運用（リセット手順）

ローカル開発環境からデータベースを完全に初期化・更新することができます。
コードベースの最新のJSONデータ (`src/data/*.json`) をデータベースに強制適用したい場合に使用します。

### 手順
1. ローカル開発環境でアプリを起動 (`npm run dev`)。
2. ブラウザで管理画面: `/admin/areas` にアクセス。
3. 画面上部の赤色ボタン **「HARD RESET DB」** をクリック。
4. 確認コード入力欄に `RESET` と入力して実行。

### ⚠️ 機能の挙動と影響
*   **削除対象**: 以下のコレクションの**全ドキュメント**が物理削除されます。
    *   `regions` (Regionマスタ)
    *   `zones` (Zoneマスタ)
    *   `areas` (Areaマスタ)
    *   `points` (Pointマスタ)
    *   `point_creatures` (生物出現情報)
*   **再生成**: ソースコード内の Mock Data (`src/data/mockData.ts`) から初期データが再投入されます。
*   **残存データ**:
    *   `users` (ユーザー情報) や `logs` (ダイビングログ) は**削除されません**。
    *   ただし、ログが参照していた古い `pointId` が削除されるため、過去のログの「場所名」などが表示されなくなる（Unknown扱いになる）可能性があります。

---

## 4. 確認事項 (変更点)

### エリア情報の反映
今回のデプロイには、**「エリア情報の再構築（Seedデータ）」** が含まれています。
アプリを開いた際（またはログイン時）に `src/utils/seeder.ts` が自動的に走り、Firestoreのデータが更新されます。

**以下の点を確認してください:**
1. **重複の解消**: エリア「伊豆」がなくなり、「伊豆半島」のみになっているか。
2. **石垣島の新区分**: 「石垣港」などが消え、「川平・石崎」「大崎・名蔵」などの地理的区分が表示されているか。
3. **管理画面**: `/admin/areas` にアクセスし、データ構造が正しいか確認。（必要であれば "Sync Master Data" ボタンを押下）

## 5. トラブルシューティング

**Q. `firebase` コマンドが見つからない**
A. `npx firebase-tools deploy ...` を使用してください。

**Q. ビルドエラー (TypeScript)**
A. `tsc -b` でエラーが出る場合はコード修正が必要です。一時的に型チェックをスキップしたい場合は `vite build` を直接実行してください（推奨されません）。

**Q. デプロイしても変更が反映されない**
A. PWAキャッシュが効いている可能性があります。ブラウザのキャッシュをクリアするか、シークレットウィンドウで確認してください。
